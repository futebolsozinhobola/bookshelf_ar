<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Biblioteca do Conhecimento AR</title>
    
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 10px; z-index: 1000; text-align: center; }
        #instructions { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 5px; font-size: 14px; max-width: 250px; z-index: 100; }
        #controls-container { position: fixed; bottom: 20px; right: 20px; display: flex; gap: 15px; z-index: 102; }
        .control-group { display: flex; flex-direction: column; gap: 10px; align-items: center;}
        .control-group span { color: white; background: rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 5px; font-size: 12px; margin-bottom: 5px;}
        .control-btn { width: 50px; height: 50px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 25px; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .control-btn:hover { background: rgba(0,0,0,0.9); }
    </style>
</head>
<body>
    <div id="loading">
        <div>Carregando AR...</div>
        <div style="font-size: 12px; margin-top: 10px;">Aponte a câmera para o marcador</div>
    </div>
    
    <div id="instructions">
        <strong>Instruções:</strong><br>
        • Aponte para o marcador Hiro.<br>
        • Use os botões para controlar o zoom e a rotação.<br>
        • Arraste na tela para girar.<br>
        • Mantenha boa iluminação.
    </div>
    
    <button id="toggle-instructions" style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; z-index: 101;">?</button>
    
    <div id="controls-container">
        <div class="control-group">
            <span>Rotação</span>
            <button class="control-btn" id="rotate-left">↺</button>
            <button class="control-btn" id="rotate-right">↻</button>
        </div>
        <div class="control-group">
            <span>Zoom</span>
            <button class="control-btn" id="zoom-in">+</button>
            <button class="control-btn" id="zoom-out">−</button>
            <button class="control-btn" id="reset-view" style="font-size: 16px;">⌂</button>
        </div>
    </div>
    
    <a-scene
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; trackingMethod: best;"
        renderer="logarithmicDepthBuffer: true; colorManagement: true; antialias: true;"
        vr-mode-ui="enabled: false"
        loading-screen="enabled: false">
        
        <a-assets>
            <a-asset-item id="bookshelf" src="assets/estante.glb"></a-asset-item>
        </a-assets>
        
        <a-light type="ambient" color="#BBB" intensity="0.7"></a-light>
        <a-light type="directional" color="#FFF" intensity="0.8" position="-2 4 2"></a-light>
        
        <a-marker preset="hiro" raycaster="objects: .clickable" emitevents="true">
            
            <a-gltf-model
                id="modelo"
                src="#bookshelf"
                position="0 0 0"
                scale="0.3 0.3 0.3"
                rotation="0 0 0"
                class="clickable">
                
                <a-animation attribute="scale" from="0 0 0" to="0.3 0.3 0.3" dur="1000" easing="ease-out-bounce" begin="markerFound"></a-animation>
                <a-animation attribute="scale" from="0.3 0.3 0.3" to="0 0 0" dur="500" easing="ease-in" begin="markerLost"></a-animation>
            </a-gltf-model>
        </a-marker>
        
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        window.addEventListener('load', () => {
            const scene = document.querySelector('a-scene');
            const loading = document.getElementById('loading');
            const instructions = document.getElementById('instructions');
            const toggleBtn = document.getElementById('toggle-instructions');
            const model = document.querySelector('#modelo');
            const marker = document.querySelector('a-marker');

            // --- Constantes de Controle ---
            const INITIAL_SCALE = { x: 0.3, y: 0.3, z: 0.3 };
            const INITIAL_ROTATION = { x: 0, y: 0, z: 0 };
            const ZOOM_STEP = 0.05;
            const ROTATION_STEP = 15; // em graus

            // Esconder tela de carregamento quando a cena estiver pronta
            scene.addEventListener('loaded', () => {
                if (loading) loading.style.display = 'none';
            });
            
            // Controle de visibilidade das instruções
            let instructionsVisible = true;
            toggleBtn.addEventListener('click', () => {
                instructionsVisible = !instructionsVisible;
                instructions.style.display = instructionsVisible ? 'block' : 'none';
                toggleBtn.textContent = instructionsVisible ? '?' : 'i';
            });
            
            // --- Lógica dos Botões de Controle ---
            document.getElementById('zoom-in').addEventListener('click', () => {
                const currentScale = model.getAttribute('scale');
                model.setAttribute('scale', {
                    x: currentScale.x + ZOOM_STEP,
                    y: currentScale.y + ZOOM_STEP,
                    z: currentScale.z + ZOOM_STEP,
                });
            });

            document.getElementById('zoom-out').addEventListener('click', () => {
                const currentScale = model.getAttribute('scale');
                const newScaleX = Math.max(0.01, currentScale.x - ZOOM_STEP);
                const newScaleY = Math.max(0.01, currentScale.y - ZOOM_STEP);
                const newScaleZ = Math.max(0.01, currentScale.z - ZOOM_STEP);
                model.setAttribute('scale', { x: newScaleX, y: newScaleY, z: newScaleZ });
            });

            document.getElementById('rotate-left').addEventListener('click', () => {
                model.object3D.rotation.y += THREE.MathUtils.degToRad(ROTATION_STEP);
            });

            document.getElementById('rotate-right').addEventListener('click', () => {
                model.object3D.rotation.y -= THREE.MathUtils.degToRad(ROTATION_STEP);
            });
            
            document.getElementById('reset-view').addEventListener('click', () => {
                model.setAttribute('scale', INITIAL_SCALE);
                model.setAttribute('rotation', INITIAL_ROTATION);
            });

            // --- Lógica de Rotação com Arraste (Mouse/Toque) ---
            let isDragging = false;
            let previousClientX = 0;
            
            const startDrag = (event) => {
                isDragging = true;
                previousClientX = event.touches ? event.touches[0].clientX : event.clientX;
                event.preventDefault();
            };
            
            const onDrag = (event) => {
                if (!isDragging) return;
                event.preventDefault();
                
                const clientX = event.touches ? event.touches[0].clientX : event.clientX;
                const deltaX = clientX - previousClientX;
                
                // Rotaciona o modelo no seu eixo Y (vertical)
                model.object3D.rotation.y += deltaX * 0.01;
                
                previousClientX = clientX;
            };
            
            const stopDrag = () => { isDragging = false; };
            
            // Eventos para mouse
            scene.addEventListener('mousedown', startDrag);
            scene.addEventListener('mousemove', onDrag);
            scene.addEventListener('mouseup', stopDrag);
            scene.addEventListener('mouseleave', stopDrag);
            
            // Eventos para toque em dispositivos móveis
            scene.addEventListener('touchstart', startDrag, { passive: false });
            scene.addEventListener('touchmove', onDrag, { passive: false });
            scene.addEventListener('touchend', stopDrag);
            
            // Feedback no console sobre o marcador
            if (marker) {
                marker.addEventListener('markerFound', () => {
                    console.log('Marcador encontrado!');
                    if (loading) loading.style.display = 'none';
                });
                
                marker.addEventListener('markerLost', () => console.log('Marcador perdido!'));
            }
        });
        
        // Prevenção de gestos de zoom/duplo-toque na página
        document.addEventListener('touchstart', (e) => { if (e.touches.length > 1) e.preventDefault(); }, { passive: false });
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) e.preventDefault();
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>
